#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æŠ–éŸ³å›¾ç‰‡ä¸‹è½½å™¨ - ä¿®æ­£ç‰ˆæœ¬
è§£å†³äº†æ‰€æœ‰ä¾èµ–å’Œå…¼å®¹æ€§é—®é¢˜
"""

import os
import re
import csv
import logging
import random
import time
import sys
from concurrent.futures import ThreadPoolExecutor, as_completed

# å®‰å…¨å¯¼å…¥ä¾èµ–åŒ…
def safe_import():
    """å®‰å…¨å¯¼å…¥æ‰€æœ‰ä¾èµ–"""
    global requests, DRISSION_AVAILABLE, PYQT_AVAILABLE

    # å¯¼å…¥requests
    try:
        import requests
        print("âœ… requestsåº“å¯ç”¨")
    except ImportError:
        print("âŒ requestsåº“ä¸å¯ç”¨ï¼Œè¯·å®‰è£…: pip install requests")
        return False

    # å¯¼å…¥DrissionPage (å¯é€‰)
    try:
        from DrissionPage import ChromiumPage
        DRISSION_AVAILABLE = True
        print("âœ… DrissionPageå¯ç”¨")
    except ImportError:
        DRISSION_AVAILABLE = False
        print("âš ï¸  DrissionPageä¸å¯ç”¨ (å¯é€‰)")

    # å¯¼å…¥PyQt5 (å¯é€‰ï¼Œç”¨äºGUI)
    try:
        from PyQt5.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
                                 QPushButton, QTextEdit, QLabel, QLineEdit, QProgressBar,
                                 QGroupBox, QFileDialog, QCheckBox, QFrame)
        from PyQt5.QtCore import Qt, QThread, pyqtSignal
        from PyQt5.QtGui import QFont
        PYQT_AVAILABLE = True
        print("âœ… PyQt5å¯ç”¨ - æ”¯æŒGUIæ¨¡å¼")
        return True
    except ImportError:
        PYQT_AVAILABLE = False
        print("âš ï¸  PyQt5ä¸å¯ç”¨ - ä»…æ”¯æŒå‘½ä»¤è¡Œæ¨¡å¼")
        print("   å®‰è£…å‘½ä»¤: pip install PyQt5")
        return True  # ä»ç„¶å¯ä»¥è¿è¡Œå‘½ä»¤è¡Œç‰ˆæœ¬

# åˆå§‹åŒ–å¯¼å…¥
if not safe_import():
    print("âŒ å…³é”®ä¾èµ–ç¼ºå¤±ï¼Œæ— æ³•è¿è¡Œ")
    sys.exit(1)

# åªæœ‰åœ¨PyQt5å¯ç”¨æ—¶æ‰å¯¼å…¥GUIç»„ä»¶
if PYQT_AVAILABLE:
    from PyQt5.QtWidgets import *
    from PyQt5.QtCore import *
    from PyQt5.QtGui import *

# é…ç½®æ—¥å¿—ç³»ç»Ÿ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('downloader.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# å…¨å±€é…ç½®
DOWNLOAD_FOLDER = 'downloaded_images'
CSV_FILE = 'image_info.csv'
MAX_THREADS = 5
DOWNLOADED_IDS_FILE = 'downloaded_ids.txt'

# åˆ›å»ºä¸‹è½½ç›®å½•
os.makedirs(DOWNLOAD_FOLDER, exist_ok=True)


class DouyinImageDownloader:
    def __init__(self):
        self.dp = None
        self.downloaded_ids = self.load_downloaded_ids()
        self.init_csv_file()

    def load_downloaded_ids(self):
        """åŠ è½½å·²ä¸‹è½½çš„å›¾ç‰‡IDï¼Œé¿å…é‡å¤ä¸‹è½½"""
        if os.path.exists(DOWNLOADED_IDS_FILE):
            with open(DOWNLOADED_IDS_FILE, 'r', encoding='utf-8') as f:
                return set(line.strip() for line in f)
        return set()

    def save_downloaded_id(self, image_id):
        """ä¿å­˜å·²ä¸‹è½½çš„å›¾ç‰‡ID"""
        with open(DOWNLOADED_IDS_FILE, 'a', encoding='utf-8') as f:
            f.write(f'{image_id}\n')
        self.downloaded_ids.add(image_id)

    def init_csv_file(self):
        """åˆå§‹åŒ–CSVæ–‡ä»¶"""
        if not os.path.exists(CSV_FILE):
            with open(CSV_FILE, 'w', newline='', encoding='utf-8-sig') as csvfile:
                writer = csv.writer(csvfile)
                writer.writerow(['author', 'target_id', 'image_url'])

    def log_to_csv(self, image_info):
        """è®°å½•å›¾ç‰‡ä¿¡æ¯åˆ°CSVæ–‡ä»¶"""
        with open(CSV_FILE, 'a', newline='', encoding='utf-8-sig') as csvfile:
            writer = csv.writer(csvfile)
            writer.writerow([
                image_info['author'],
                image_info['target_id'],
                image_info['image_url']
            ])

    def init_browser(self):
        """åˆå§‹åŒ–æµè§ˆå™¨å¹¶è®¾ç½®ç›‘å¬å™¨"""
        if not DRISSION_AVAILABLE:
            logger.error('DrissionPage æœªå®‰è£…ï¼Œæ— æ³•ä½¿ç”¨æµè§ˆå™¨è‡ªåŠ¨åŒ–åŠŸèƒ½')
            return False

        try:
            from DrissionPage import ChromiumPage
            self.dp = ChromiumPage()
            self.dp.listen.start('v1/web/aweme/listcollection/')
            self.dp.get('https://www.douyin.com/user/self?from_tab_name=main&showTab=favorite_collection')
            logger.info('æµè§ˆå™¨åˆå§‹åŒ–å®Œæˆ')
            return True
        except Exception as e:
            logger.error(f'æµè§ˆå™¨åˆå§‹åŒ–å¤±è´¥: {str(e)}')
            return False

    def collect_image_info(self, max_pages=5):
        """é‡‡é›†å›¾ç‰‡ä¿¡æ¯"""
        if not self.dp:
            logger.error('æµè§ˆå™¨æœªåˆå§‹åŒ–')
            return []

        image_info_list = []

        # æ–°å¢ï¼šå…è®¸ç”¨æˆ·è¾“å…¥æ»šåŠ¨ç±»å
        scroll_class = getattr(self, 'scroll_class', None)
        if not scroll_class:
            scroll_class = 'gqga5U3W'  # é»˜è®¤ç±»å
        scroll_selector = f'css:.{scroll_class}'

        for page in range(1, max_pages + 1):
            try:
                r = self.dp.listen.wait()
                logger.info(f'æ­£åœ¨é‡‡é›†ç¬¬{page}é¡µ')
                json_data = r.response.body

                info_list = json_data.get('aweme_list', [])
                if not info_list:
                    logger.info('æœªæ‰¾åˆ°aweme_listï¼Œç»“æŸé‡‡é›†ã€‚ ')
                    break

                for item in info_list:
                    try:
                        target_id = item['aweme_id']
                        author = item['author']['nickname']
                        # æ¸…ç†æ–‡ä»¶åç‰¹æ®Šå­—ç¬¦
                        nickname = re.sub(r'[\\/:*?" <>|]', '', author)
                        images = item.get('images')

                        if not images:
                            logger.warning(f'ä½œå“{target_id}æ²¡æœ‰å›¾ç‰‡ï¼Œè·³è¿‡')
                            continue

                        logger.info(f'æ­£åœ¨å¤„ç†ã€{author}ã€‘çš„ä½œå“ {target_id}')
                        for idx, image in enumerate(images):
                            image_url = image['url_list'][-1]
                            image_id = f'{target_id}_{idx + 1}'
                            if image_id in self.downloaded_ids:
                                logger.info(f'å›¾ç‰‡ {image_id} å·²ä¸‹è½½ï¼Œè·³è¿‡')
                                continue

                            image_info_list.append({
                                'author': author,
                                'nickname': nickname,
                                'target_id': target_id,
                                'image_id': image_id,
                                'image_url': image_url
                            })
                    except Exception as e:
                        logger.error(f'å¤„ç†ä½œå“æ—¶å‡ºé”™: {str(e)}', exc_info=True)
                        continue

                # æ»šåŠ¨åŠ è½½æ›´å¤š
                self.dp.scroll.to_see(scroll_selector)
                # éšæœºç­‰å¾…1-3ç§’
                time.sleep(random.uniform(1, 5))
            except Exception as e:
                logger.error(f'é‡‡é›†ç¬¬{page}é¡µæ—¶å‡ºé”™: {str(e)}', exc_info=True)
                continue

        return image_info_list

    def download_image(self, image_info):
        """ä¸‹è½½å•å¼ å›¾ç‰‡"""
        try:
            response = requests.get(image_info['image_url'], timeout=15)
            response.raise_for_status()

            # ä¿å­˜å›¾ç‰‡
            filename = f"{image_info['nickname']}_{image_info['image_id']}.jpg"
            filepath = os.path.join(DOWNLOAD_FOLDER, filename)

            with open(filepath, 'wb') as f:
                f.write(response.content)

            # è®°å½•å·²ä¸‹è½½IDå’ŒCSVä¿¡æ¯
            self.save_downloaded_id(image_info['image_id'])
            self.log_to_csv(image_info)

            logger.info(f'ä¸‹è½½æˆåŠŸ: {filename}')
            return True
        except Exception as e:
            logger.error(f'ä¸‹è½½ {image_info["image_url"]} æ—¶å‡ºé”™: {str(e)}', exc_info=True)
            return False

    def download_images_multithreaded(self, image_info_list, max_threads=5):
        """å¤šçº¿ç¨‹ä¸‹è½½å›¾ç‰‡"""
        if not image_info_list:
            logger.info('æ²¡æœ‰å›¾ç‰‡éœ€è¦ä¸‹è½½')
            return 0, 0

        logger.info(f'å¼€å§‹å¤šçº¿ç¨‹ä¸‹è½½ï¼Œå…±{len(image_info_list)}å¼ å›¾ç‰‡')
        success_count = 0
        fail_count = 0

        with ThreadPoolExecutor(max_workers=max_threads) as executor:
            futures = {executor.submit(self.download_image, info): info for info in image_info_list}

            for future in as_completed(futures):
                image_info = futures[future]
                try:
                    result = future.result()
                    if result:
                        success_count += 1
                    else:
                        fail_count += 1
                except Exception as e:
                    fail_count += 1
                    logger.error(f'å¤„ç†å›¾ç‰‡ {image_info.get("image_id")} æ—¶å‡ºé”™: {str(e)}', exc_info=True)

        logger.info(f'ä¸‹è½½å®Œæˆ: æˆåŠŸ {success_count} å¼ , å¤±è´¥ {fail_count} å¼ ')
        return success_count, fail_count

    def start_download(self, max_pages=5, max_threads=5):
        """å¯åŠ¨ä¸‹è½½æµç¨‹"""
        if not self.init_browser():
            return 0, 0

        logger.info('å¼€å§‹é‡‡é›†å›¾ç‰‡ä¿¡æ¯')
        image_info_list = self.collect_image_info(max_pages)

        if not image_info_list:
            logger.info('æ²¡æœ‰æ‰¾åˆ°å¯ä¸‹è½½çš„å›¾ç‰‡ä¿¡æ¯')
            return 0, 0

        return self.download_images_multithreaded(image_info_list, max_threads)


# åªæœ‰åœ¨PyQt5å¯ç”¨æ—¶æ‰å®šä¹‰GUIç›¸å…³ç±»
if PYQT_AVAILABLE:

    class DownloadThread(QThread):
        """æ‰§è¡Œä¸‹è½½ä»»åŠ¡çš„çº¿ç¨‹"""
        update_log = pyqtSignal(str)
        update_progress = pyqtSignal(int, int, int)
        finished = pyqtSignal(int, int)
        error = pyqtSignal(str)

        def __init__(self, max_pages, max_threads):
            super().__init__()
            self.max_pages = max_pages
            self.max_threads = max_threads
            self.downloader = DouyinImageDownloader()

            # é‡å®šå‘æ—¥å¿—åˆ°GUI
            self.log_handler = self.GuiLogHandler(self.update_log)
            logger.addHandler(self.log_handler)

        class GuiLogHandler(logging.Handler):
            """è‡ªå®šä¹‰æ—¥å¿—å¤„ç†å™¨ï¼Œå°†æ—¥å¿—å‘é€åˆ°GUI"""

            def __init__(self, emit_signal):
                super().__init__()
                self.emit_signal = emit_signal

            def emit(self, record):
                log_entry = self.format(record)
                self.emit_signal.emit(log_entry)

        def run(self):
            try:
                success, fail = self.downloader.start_download(self.max_pages, self.max_threads)
                self.finished.emit(success, fail)
            except Exception as e:
                self.error.emit(f"ä¸‹è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {str(e)}")
            finally:
                # ç§»é™¤è‡ªå®šä¹‰æ—¥å¿—å¤„ç†å™¨
                logger.removeHandler(self.log_handler)

    class ModernButton(QPushButton):
        """ç°ä»£åŒ–æŒ‰é’®ç»„ä»¶"""
        def __init__(self, text, button_type="primary"):
            super().__init__(text)
            self.button_type = button_type
            self.setFixedHeight(45)
            self.setCursor(Qt.PointingHandCursor)
            self.setStyleSheet(self.get_style())

        def get_style(self):
            if self.button_type == "primary":
                return """
                    QPushButton {
                        background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                                    stop: 0 #4CAF50, stop: 1 #45a049);
                        border: none;
                        border-radius: 22px;
                        color: white;
                        font-size: 14px;
                        font-weight: bold;
                        padding: 12px 24px;
                    }
                    QPushButton:hover {
                        background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                                    stop: 0 #5CBF60, stop: 1 #4CAF50);
                    }
                    QPushButton:pressed {
                        background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                                    stop: 0 #45a049, stop: 1 #3d8b40);
                    }
                    QPushButton:disabled {
                        background: #cccccc;
                        color: #666666;
                    }
                """
            elif self.button_type == "danger":
                return """
                    QPushButton {
                        background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                                    stop: 0 #f44336, stop: 1 #d32f2f);
                        border: none;
                        border-radius: 22px;
                        color: white;
                        font-size: 14px;
                        font-weight: bold;
                        padding: 12px 24px;
                    }
                    QPushButton:hover {
                        background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                                    stop: 0 #f55a4e, stop: 1 #f44336);
                    }
                    QPushButton:pressed {
                        background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                                    stop: 0 #d32f2f, stop: 1 #b71c1c);
                    }
                    QPushButton:disabled {
                        background: #cccccc;
                        color: #666666;
                    }
                """
            else:  # secondary
                return """
                    QPushButton {
                        background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                                    stop: 0 #2196F3, stop: 1 #1976D2);
                        border: none;
                        border-radius: 22px;
                        color: white;
                        font-size: 14px;
                        font-weight: bold;
                        padding: 12px 24px;
                    }
                    QPushButton:hover {
                        background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                                    stop: 0 #42A5F5, stop: 1 #2196F3);
                    }
                    QPushButton:pressed {
                        background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                                    stop: 0 #1976D2, stop: 1 #1565C0);
                    }
                """

    class DouyinDownloaderApp(QMainWindow):
        def __init__(self):
            super().__init__()
            self.setWindowTitle("æŠ–éŸ³å›¾ç‰‡ä¸‹è½½å™¨ - ä¿®æ­£ç‰ˆæœ¬")
            self.setGeometry(800, 400, 1200, 1000)
            self.setMinimumSize(800, 600)

            # è®¾ç½®çª—å£æ ·å¼
            self.setStyleSheet("""
                QMainWindow {
                    background: qlineargradient(x1: 0, y1: 0, x2: 0, y2: 1,
                                stop: 0 #667eea, stop: 1 #764ba2);
                }
            """)

            self.init_ui()
            self.download_thread = None

        def init_ui(self):
            """åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢ - ç®€åŒ–ç‰ˆæœ¬"""
            main_widget = QWidget()
            main_layout = QVBoxLayout()
            main_layout.setSpacing(20)
            main_layout.setContentsMargins(30, 30, 30, 30)

            # æ ‡é¢˜
            title = QLabel("ğŸµ æŠ–éŸ³å›¾ç‰‡ä¸‹è½½å™¨")
            title.setFont(QFont("Arial", 28, QFont.Bold))  # è°ƒå¤§æ ‡é¢˜å­—å·
            title.setAlignment(Qt.AlignCenter)
            title.setStyleSheet("color: white; margin: 20px;")
            main_layout.addWidget(title)

            # é…ç½®åŒºåŸŸ
            config_group = QGroupBox("ä¸‹è½½è®¾ç½®")
            config_group.setStyleSheet("""
                QGroupBox {
                    font-size: 22px; /* è°ƒå¤§è®¾ç½®åŒºåŸŸæ ‡é¢˜å­—å· */
                    font-weight: bold;
                    color: #2c3e50;
                    border: 2px solid #e0e0e0;
                    border-radius: 10px;
                    margin-top: 10px;
                    padding-top: 35px; /* æ ‡é¢˜å†ä¸‹ç§» */
                    background: rgba(255, 255, 255, 0.9);
                }
                QGroupBox::title {
                    subcontrol-origin: margin;
                    left: 0px; /* é è¿‘å·¦ä¸Šè§’ */
                    top: 24px; /* æ ‡é¢˜å†ä¸‹ç§» */
                    padding: 0 10px 0 10px;
                    font-size: 22px; /* æ ‡é¢˜å­—å·åŠ å¤§ */
                }
            """)
            config_layout = QVBoxLayout()

            # è®¾ç½®è¾“å…¥
            settings_layout = QHBoxLayout()

            settings_layout.addWidget(QLabel("é‡‡é›†é¡µæ•°:"))
            self.pages_input = QLineEdit("5")
            self.pages_input.setMaximumWidth(60)
            self.pages_input.setFont(QFont("Arial", 14))  # è°ƒå¤§è¾“å…¥æ¡†å­—å·
            settings_layout.addWidget(self.pages_input)

            settings_layout.addWidget(QLabel("çº¿ç¨‹æ•°:"))
            self.threads_input = QLineEdit("5")
            self.threads_input.setMaximumWidth(60)
            self.threads_input.setFont(QFont("Arial", 14))  # è°ƒå¤§è¾“å…¥æ¡†å­—å·
            settings_layout.addWidget(self.threads_input)

            # æ–°å¢ï¼šæ»šåŠ¨ç±»åè¾“å…¥
            settings_layout.addWidget(QLabel("æ»šåŠ¨ç±»å:"))
            self.scroll_class_input = QLineEdit("gqga5U3W")
            self.scroll_class_input.setMaximumWidth(120)
            self.scroll_class_input.setFont(QFont("Arial", 8))
            settings_layout.addWidget(self.scroll_class_input)

            settings_layout.addStretch()
            config_layout.addLayout(settings_layout)

            # ç›®å½•é€‰æ‹©
            dir_layout = QHBoxLayout()
            dir_layout.addWidget(QLabel("ä¸‹è½½ç›®å½•:"))
            self.dir_input = QLineEdit(DOWNLOAD_FOLDER)
            self.dir_input.setFont(QFont("Arial", 14))  # è°ƒå¤§è¾“å…¥æ¡†å­—å·
            dir_layout.addWidget(self.dir_input)

            self.browse_btn = QPushButton("æµè§ˆ")
            self.browse_btn.clicked.connect(self.browse_directory)
            dir_layout.addWidget(self.browse_btn)
            config_layout.addLayout(dir_layout)

            config_group.setLayout(config_layout)
            main_layout.addWidget(config_group)

            # è¿›åº¦æ¡
            self.progress_label = QLabel("å‡†å¤‡å¼€å§‹...")
            self.progress_label.setStyleSheet("color: white; font-weight: bold; font-size: 18px;")  # è°ƒå¤§è¿›åº¦æ ‡ç­¾å­—å·
            main_layout.addWidget(self.progress_label)

            self.progress_bar = QProgressBar()
            self.progress_bar.setStyleSheet("""
                QProgressBar {
                    border: 2px solid grey;
                    border-radius: 5px;
                    text-align: center;
                    font-size: 16px; /* è°ƒå¤§è¿›åº¦æ¡å­—å· */
                }
                QProgressBar::chunk {
                    background-color: #4CAF50;
                    border-radius: 3px;
                }
            """)
            main_layout.addWidget(self.progress_bar)

            # æ§åˆ¶æŒ‰é’®
            btn_layout = QHBoxLayout()

            if PYQT_AVAILABLE:
                self.start_btn = ModernButton("ğŸš€ å¼€å§‹ä¸‹è½½", "primary")
                self.start_btn.setFont(QFont("Arial", 16))  # è°ƒå¤§æŒ‰é’®å­—å·
                self.stop_btn = ModernButton("â¹ï¸ åœæ­¢", "danger")
                self.stop_btn.setFont(QFont("Arial", 16))  # è°ƒå¤§æŒ‰é’®å­—å·
            else:
                self.start_btn = QPushButton("å¼€å§‹ä¸‹è½½")
                self.start_btn.setFont(QFont("Arial", 20))
                self.stop_btn = QPushButton("åœæ­¢")
                self.stop_btn.setFont(QFont("Arial", 20))

            self.start_btn.clicked.connect(self.start_download)
            self.stop_btn.clicked.connect(self.stop_download)
            self.stop_btn.setEnabled(False)

            btn_layout.addWidget(self.start_btn)
            btn_layout.addWidget(self.stop_btn)
            main_layout.addLayout(btn_layout)

            # æ—¥å¿—åŒºåŸŸ
            log_group = QGroupBox("æ“ä½œæ—¥å¿—")
            log_group.setStyleSheet("""
                QGroupBox {
                    font-size: 22px; /* è°ƒå¤§è®¾ç½®åŒºåŸŸæ ‡é¢˜å­—å· */
                    font-weight: bold;
                    color: #2c3e50;
                    border: 2px solid #e0e0e0;
                    border-radius: 10px;
                    margin-top: 10px;
                    padding-top: 35px; /* æ ‡é¢˜å†ä¸‹ç§» */
                    background: rgba(255, 255, 255, 0.9);
                }
                QGroupBox::title {
                    subcontrol-origin: margin;
                    left: 0px; /* é è¿‘å·¦ä¸Šè§’ */
                    top: 24px; /* æ ‡é¢˜å†ä¸‹ç§» */
                    padding: 0 10px 0 10px;
                    font-size: 22px; /* æ ‡é¢˜å­—å·åŠ å¤§ */
                }
            """)
            log_layout = QVBoxLayout()

            self.log_text = QTextEdit()
            self.log_text.setReadOnly(True)
            self.log_text.setStyleSheet("""
                QTextEdit {
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    padding: 10px;
                    font-family: Consolas, monospace;
                    font-size: 24px; /* æ—¥å¿—è¾“å‡ºå­—ä½“æ›´å¤§ */
                }
            """)
            log_layout.addWidget(self.log_text)
            log_group.setLayout(log_layout)
            main_layout.addWidget(log_group)

            main_widget.setLayout(main_layout)
            self.setCentralWidget(main_widget)

        def browse_directory(self):
            """é€‰æ‹©ä¸‹è½½ç›®å½•"""
            global DOWNLOAD_FOLDER
            directory = QFileDialog.getExistingDirectory(self, "é€‰æ‹©ä¸‹è½½ç›®å½•", DOWNLOAD_FOLDER)
            if directory:
                DOWNLOAD_FOLDER = directory
                self.dir_input.setText(directory)

        def start_download(self):
            """å¼€å§‹ä¸‹è½½è¿‡ç¨‹"""
            if not DRISSION_AVAILABLE:
                self.log_text.append("âŒ é”™è¯¯ï¼šDrissionPageæœªå®‰è£…ï¼Œæ— æ³•è¿›è¡Œä¸‹è½½")
                self.log_text.append("   å®‰è£…å‘½ä»¤: pip install DrissionPage")
                return

            global DOWNLOAD_FOLDER
            DOWNLOAD_FOLDER = self.dir_input.text()
            os.makedirs(DOWNLOAD_FOLDER, exist_ok=True)

            try:
                max_pages = int(self.pages_input.text())
                max_threads = int(self.threads_input.text())
                scroll_class = self.scroll_class_input.text().strip() or "gqga5U3W"
            except ValueError:
                self.log_text.append("âŒ é”™è¯¯ï¼šé¡µæ•°å’Œçº¿ç¨‹æ•°å¿…é¡»æ˜¯æ•´æ•°")
                return

            self.start_btn.setEnabled(False)
            self.stop_btn.setEnabled(True)
            self.progress_bar.setValue(0)
            self.progress_label.setText("ğŸ”„ æ­£åœ¨åˆå§‹åŒ–...")

            self.download_thread = DownloadThread(max_pages, max_threads)
            # ä¼ é€’æ»šåŠ¨ç±»å
            self.download_thread.downloader.scroll_class = scroll_class
            self.download_thread.update_log.connect(self.update_log)
            self.download_thread.finished.connect(self.download_finished)
            self.download_thread.error.connect(self.show_error)
            self.download_thread.start()

        def stop_download(self):
            """åœæ­¢ä¸‹è½½è¿‡ç¨‹"""
            if self.download_thread and self.download_thread.isRunning():
                self.download_thread.terminate()
                self.log_text.append("â¹ï¸ ä¸‹è½½å·²åœæ­¢")
                self.progress_label.setText("â¹ï¸ ä¸‹è½½å·²åœæ­¢")
                self.start_btn.setEnabled(True)
                self.stop_btn.setEnabled(False)

        def update_log(self, message):
            """æ›´æ–°æ—¥å¿—æ˜¾ç¤º"""
            self.log_text.append(message)
            self.log_text.verticalScrollBar().setValue(self.log_text.verticalScrollBar().maximum())

        def download_finished(self, success, fail):
            """ä¸‹è½½å®Œæˆå¤„ç†"""
            self.progress_bar.setValue(100)
            self.progress_label.setText(f"ğŸ‰ ä¸‹è½½å®Œæˆ! æˆåŠŸ: {success}, å¤±è´¥: {fail}")
            self.start_btn.setEnabled(True)
            self.stop_btn.setEnabled(False)
            self.log_text.append(f"ğŸ‰ ä¸‹è½½å®Œæˆ! æˆåŠŸ {success} å¼ ï¼Œå¤±è´¥ {fail} å¼ ")

        def show_error(self, message):
            """æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯"""
            self.log_text.append(f"âŒ {message}")
            self.progress_label.setText("âŒ ä¸‹è½½å‡ºé”™")
            self.start_btn.setEnabled(True)
            self.stop_btn.setEnabled(False)


def run_cli_mode():
    """è¿è¡Œå‘½ä»¤è¡Œæ¨¡å¼"""
    print("ğŸµ æŠ–éŸ³å›¾ç‰‡ä¸‹è½½å™¨ - å‘½ä»¤è¡Œæ¨¡å¼")
    print("(GUIæ¨¡å¼ä¸å¯ç”¨ï¼ŒPyQt5æœªå®‰è£…)")
    print("=" * 50)

    if not DRISSION_AVAILABLE:
        print("âŒ DrissionPageæœªå®‰è£…ï¼Œæ— æ³•ä½¿ç”¨æµè§ˆå™¨è‡ªåŠ¨åŒ–åŠŸèƒ½")
        print("   å®‰è£…å‘½ä»¤: pip install DrissionPage")
        return

    try:
        max_pages = input("ğŸ“„ è¯·è¾“å…¥é‡‡é›†é¡µæ•° (é»˜è®¤: 5): ").strip()
        max_pages = int(max_pages) if max_pages else 5

        max_threads = input("ğŸ§µ è¯·è¾“å…¥ä¸‹è½½çº¿ç¨‹æ•° (é»˜è®¤: 5): ").strip()
        max_threads = int(max_threads) if max_threads else 5

    except ValueError:
        print("âŒ è¾“å…¥é”™è¯¯ï¼Œä½¿ç”¨é»˜è®¤å€¼")
        max_pages = 5
        max_threads = 5

    downloader = DouyinImageDownloader()
    success, fail = downloader.start_download(max_pages, max_threads)

    print(f"\nğŸ‰ ä¸‹è½½å®Œæˆ!")
    print(f"   âœ… æˆåŠŸ: {success} å¼ ")
    print(f"   âŒ å¤±è´¥: {fail} å¼ ")


def main():
    """ä¸»å‡½æ•° - è‡ªåŠ¨é€‰æ‹©GUIæˆ–å‘½ä»¤è¡Œæ¨¡å¼"""
    if PYQT_AVAILABLE:
        # GUIæ¨¡å¼
        app = QApplication(sys.argv)
        app.setStyle('Fusion')

        window = DouyinDownloaderApp()
        window.show()

        sys.exit(app.exec_())
    else:
        # å‘½ä»¤è¡Œæ¨¡å¼
        run_cli_mode()


if __name__ == '__main__':
    main()
